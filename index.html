<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Registro de Asistencia</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<header class="header">
    <img src="marina.png" alt="Marina" class="logo">
    <img src="marina_grupo.png" alt="Grupo Aeroportuario" class="logo">
    <img src="aicm.png" alt="AICM" class="logo">
</header>

<section class="hero">
    <h1>Registro de Asistencia</h1>
    <p class="sub">Por favor complete sus datos y firme al final</p>
</section>

<main>
    <form id="asistenciaForm" class="form-card">
        <div class="field">
            <label for="nombre">Nombre</label>
            <input id="nombre" name="nombre" type="text" required />
        </div>

        <div class="field">
            <label for="correo">Correo</label>
            <input id="correo" name="correo" type="email" required />
        </div>

        <div class="field">
            <label for="empresa">Empresa</label>
            <input id="empresa" name="empresa" type="text" required />
        </div>

        <div class="field">
            <label for="telefono">Teléfono</label>
            <input id="telefono" name="telefono" type="tel" required />
        </div>

        <div class="field">
            <label>Firma</label>
            <canvas id="signature-pad" class="signature-pad" width="300" height="150"></canvas>
            <div class="signature-controls">
                <button type="button" id="clearBtn" class="btn-ghost">Borrar firma</button>
                <small class="hint">Firma con dedo o mouse</small>
            </div>
        </div>

        <div class="actions">
            <button id="submitBtn" type="button" class="btn">Registrar asistencia</button>
        </div>

        <p id="status" class="status" aria-live="polite"></p>
    </form>
</main>

<footer class="footer">
    <img src="ano_mujer.png" alt="Año de la Mujer" class="logo-footer">
</footer>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // ========================
    // CONFIGURACIÓN SUPABASE (Reemplaza con tus llaves reales si cambian)
    // ========================
    const SUPABASE_URL = "https://kdacskidrbbqbstizekl.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtkYWNza2lkcmJicWJzdGl6ZWtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNTQ1NDIsImV4cCI6MjA3NjczMDU0Mn0.SqnbCRbwI4EWYp14VAF8HR5SmeaF4FNI5bUVOCuD0wM";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ========================
    // ELEMENTOS DOM y SignaturePad
    // ========================
    const canvas = document.getElementById("signature-pad");
    const clearBtn = document.getElementById("clearBtn");
    const submitBtn = document.getElementById("submitBtn");
    const statusEl = document.getElementById("status");
    let sigPad = null;

    // Ajustar tamaño del canvas para pantallas con devicePixelRatio (CLAVE para la calidad en tablets/smartphones)
    function resizeCanvas() {
        // Guarda los datos de la firma antes de redimensionar
        const data = sigPad ? sigPad.toData() : [];
        const ratio = Math.max(window.devicePixelRatio || 1, 1);

        // Establece el ancho y alto interno del canvas basado en el tamaño visual (CSS)
        canvas.width = Math.floor(canvas.offsetWidth * ratio);
        canvas.height = Math.floor(canvas.offsetHeight * ratio);

        // Escala el contexto y recarga la firma
        if (sigPad) {
            const ctx = canvas.getContext("2d");
            ctx.scale(ratio, ratio);
            sigPad.fromData(data);
            if (data.length === 0) sigPad.clear(); // Limpia si estaba vacía
        }
    }

    // Inicialización
    sigPad = new SignaturePad(canvas, {
        backgroundColor: 'rgb(255,255,255)',
        penColor: 'rgb(0, 0, 0)' // Asegura color de trazo negro
    });
    resizeCanvas(); // Llamada inicial

    // Event Listeners
    window.addEventListener('resize', resizeCanvas); // Adaptación al girar/cambiar tamaño
    clearBtn.addEventListener('click', () => {
        sigPad.clear();
    });

    // Obtener sessionId desde querystring (opcional)
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('sessionId') || null;

    // ========================
    // FUNCIÓN PRINCIPAL: Registrar Asistencia
    // ========================
    async function registrarAsistencia() {
        statusEl.textContent = '';
        submitBtn.disabled = true;
        submitBtn.textContent = 'Registrando...';

        try {
            // 1. Validaciones
            const nombre = document.getElementById('nombre').value.trim();
            const correo = document.getElementById('correo').value.trim();
            const empresa = document.getElementById('empresa').value.trim();
            const telefono = document.getElementById('telefono').value.trim();

            if (!nombre || !correo || !empresa || !telefono) {
                statusEl.textContent = '⚠️ Por favor, completa todos los campos.';
                return;
            }

            if (sigPad.isEmpty()) {
                statusEl.textContent = '⚠️ Por favor, firma antes de enviar.';
                return;
            }

            // 2. Convertir la firma a blob
            const dataURL = sigPad.toDataURL('image/png');
            const res = await fetch(dataURL);
            const blob = await res.blob();

            // 3. Subir a Supabase Storage
            const safeName = nombre.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, '');
            const archivo = `firmas/${Date.now()}_${safeName}.png`;

            const { error: uploadError } = await supabase.storage
                .from('firmas')
                .upload(archivo, blob, { contentType: 'image/png' });

            if (uploadError) throw uploadError;

            // 4. Obtener URL pública
            const { data: publicUrlData } = supabase.storage.from('firmas').getPublicUrl(archivo);
            const firma_url = publicUrlData.publicUrl;

            // 5. Insertar en la tabla 'asistencias'
            const { error: insertError } = await supabase
                .from('asistencias')
                .insert([{ nombre, correo, empresa, telefono, firma_url, session_id: sessionId }]);

            if (insertError) throw insertError;

            // Éxito
            statusEl.textContent = '✅ Asistencia registrada correctamente.';
            document.getElementById('asistenciaForm').reset();
            sigPad.clear();
        } catch (err) {
            console.error('Error al subir firma / insertar registro:', err);
            statusEl.textContent = '❌ Error al registrar asistencia. Revisa la consola.';
        } finally {
            // Se ejecuta siempre, asegurando que el botón se re-habilite
            submitBtn.disabled = false;
            submitBtn.textContent = 'Registrar asistencia';
        }
    }

    submitBtn.addEventListener('click', registrarAsistencia);
</script>
</body>
</html>