<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // ========================
    // CONFIGURACIÓN SUPABASE
    // ========================
    const SUPABASE_URL = "https://kdacskidrbbqbstizekl.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtkYWNza2lkcmJicWJzdGl6ZWtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNTQ1NDIsImV4cCI6MjA3NjczMDU0Mn0.SqnbCRbwI4EWYp14VAF8HR5cSmeaF4FNI5bUVOCuD0wM";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // ========================
    // ELEMENTOS DOM
    // ========================
    const canvas = document.getElementById("signature-pad");
    const clearBtn = document.getElementById("clearBtn");
    const submitBtn = document.getElementById("submitBtn");
    const statusEl = document.getElementById("status");

    // Ajustar tamaño del canvas
    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = Math.floor(canvas.offsetWidth * ratio);
        canvas.height = Math.floor(canvas.offsetHeight * ratio);
        const ctx = canvas.getContext("2d");
        ctx.scale(ratio, ratio);
    }

    resizeCanvas();
    const sigPad = new SignaturePad(canvas, { backgroundColor: 'rgb(255,255,255)' });

    window.addEventListener('resize', () => {
        resizeCanvas();
        sigPad.clear();
    });

    clearBtn.addEventListener('click', () => sigPad.clear());

    // Obtener sessionId si existe
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('sessionId') || null;

    // ========================
    // FUNCION PRINCIPAL
    // ========================
    async function registrarAsistencia() {
        statusEl.textContent = '';
        submitBtn.disabled = true;
        submitBtn.textContent = 'Registrando...';

        try {
            const nombre = document.getElementById('nombre').value.trim();
            const correo = document.getElementById('correo').value.trim();
            const empresa = document.getElementById('empresa').value.trim();
            const telefono = document.getElementById('telefono').value.trim();

            if (!nombre || !correo || !empresa || !telefono) {
                statusEl.textContent = 'Por favor completa todos los campos.';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Registrar asistencia';
                return;
            }

            if (sigPad.isEmpty()) {
                statusEl.textContent = 'Por favor firma antes de enviar.';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Registrar asistencia';
                return;
            }

            // Convertir firma a blob
            const dataURL = sigPad.toDataURL('image/png');
            const res = await fetch(dataURL);
            const blob = await res.blob();

            // Nombre de archivo único
            const safeName = nombre.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, '');
            const archivo = `firmas/${Date.now()}_${safeName}.png`;

            // Subir a Supabase Storage con upsert
            const { data: uploadData, error: uploadError } = await supabase.storage
                .from('firmas')
                .upload(archivo, blob, { contentType: 'image/png', upsert: true });

            if (uploadError) throw uploadError;

            // Obtener URL pública
            const { data: publicUrlData, error: urlError } = supabase.storage
                .from('firmas')
                .getPublicUrl(archivo);

            if (urlError) throw urlError;
            const firma_url = publicUrlData.publicUrl;

            // Insertar registro en tabla 'asistencias'
            const { error: insertError } = await supabase
                .from('asistencias')
                .insert([{ nombre, correo, empresa, telefono, firma_url, session_id: sessionId }]);

            if (insertError) throw insertError;

            statusEl.textContent = '✅ Asistencia registrada correctamente.';
            document.getElementById('asistenciaForm').reset();
            sigPad.clear();

        } catch (err) {
            console.error('Error al subir firma / insertar registro:', err);
            statusEl.textContent = '❌ Error al registrar asistencia. Revisa la consola.';
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Registrar asistencia';
        }
    }

    submitBtn.addEventListener('click', registrarAsistencia);
</script>
