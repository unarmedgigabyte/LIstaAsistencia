<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Registro de Asistencia</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Tamaño fijo del canvas para que SignaturePad funcione correctamente */
        .signature-pad {
            border: 1px solid #ccc;
            width: 100%;
            max-width: 500px;
            height: 200px;
        }
    </style>
</head>
<body>
<header class="header">
    <img src="marina.png" alt="Marina" class="logo">
    <img src="marina_grupo.png" alt="Grupo Aeroportuario" class="logo">
    <img src="aicm.png" alt="AICM" class="logo">
</header>

<section class="hero">
    <h1>Registro de Asistencia</h1>
    <p class="sub">Por favor complete sus datos y firme al final</p>
</section>

<main>
    <form id="asistenciaForm" class="form-card">
        <div class="field">
            <label for="nombre">Nombre</label>
            <input id="nombre" type="text" required>
        </div>
        <div class="field">
            <label for="correo">Correo</label>
            <input id="correo" type="email" required>
        </div>
        <div class="field">
            <label for="empresa">Empresa</label>
            <input id="empresa" type="text" required>
        </div>
        <div class="field">
            <label for="telefono">Teléfono</label>
            <input id="telefono" type="tel" required>
        </div>
        <div class="field">
            <label>Firma</label>
            <canvas id="signature-pad" class="signature-pad"></canvas>
            <div>
                <button type="button" id="clearBtn">Borrar firma</button>
            </div>
        </div>
        <div class="actions">
            <button type="button" id="submitBtn">Registrar asistencia</button>
        </div>
        <p id="status"></p>
    </form>
</main>

<footer class="footer">
    <img src="ano_mujer.png" alt="Año de la Mujer" class="logo-footer">
</footer>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // CONFIGURACIÓN SUPABASE
    const SUPABASE_URL = "https://kdacskidrbbqbstizekl.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtkYWNza2lkcmJicWJzdGl6ZWtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNTQ1NDIsImV4cCI6MjA3NjczMDU0Mn0.SqnbCRbwI4EWYp14VAF8HR5cSmeaF4FNI5bUVOCuD0wM";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const canvas = document.getElementById('signature-pad');
    const clearBtn = document.getElementById('clearBtn');
    const submitBtn = document.getElementById('submitBtn');
    const statusEl = document.getElementById('status');

    // Ajustar canvas a tamaño fijo para SignaturePad
    function prepareCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        const ctx = canvas.getContext('2d');
        ctx.scale(ratio, ratio);
    }

    prepareCanvas();
    window.addEventListener('resize', () => {
        prepareCanvas();
        signaturePad.clear();
    });

    // Inicializar SignaturePad
    const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255,255,255)' });

    clearBtn.addEventListener('click', () => signaturePad.clear());

    const sessionId = new URLSearchParams(window.location.search).get('sessionId') || null;

    async function registrarAsistencia() {
        statusEl.textContent = '';
        submitBtn.disabled = true;
        submitBtn.textContent = 'Registrando...';

        try {
            const nombre = document.getElementById('nombre').value.trim();
            const correo = document.getElementById('correo').value.trim();
            const empresa = document.getElementById('empresa').value.trim();
            const telefono = document.getElementById('telefono').value.trim();

            if (!nombre || !correo || !empresa || !telefono) {
                statusEl.textContent = 'Por favor completa todos los campos.';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Registrar asistencia';
                return;
            }

            if (signaturePad.isEmpty()) {
                statusEl.textContent = 'Por favor firma antes de enviar.';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Registrar asistencia';
                return;
            }

            // Convertir la firma a blob correctamente
            const dataURL = signaturePad.toDataURL('image/png');
            const blob = await (await fetch(dataURL)).blob();

            const safeName = nombre.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, '');
            const archivo = `firmas/${Date.now()}_${safeName}.png`;

            const { error: uploadError } = await supabase.storage
                .from('firmas')
                .upload(archivo, blob, { contentType: 'image/png', upsert: true });

            if (uploadError) throw uploadError;

            const { data: publicUrlData, error: urlError } = supabase.storage
                .from('firmas')
                .getPublicUrl(archivo);

            if (urlError) throw urlError;

            const firma_url = publicUrlData.publicUrl;

            const { error: insertError } = await supabase
                .from('asistencias')
                .insert([{ nombre, correo, empresa, telefono, firma_url, session_id: sessionId }]);

            if (insertError) throw insertError;

            statusEl.textContent = '✅ Asistencia registrada correctamente.';
            document.getElementById('asistenciaForm').reset();
            signaturePad.clear();

        } catch (err) {
            console.error('Error al registrar:', err);
            statusEl.textContent = '❌ Error al registrar asistencia. Revisa la consola.';
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Registrar asistencia';
        }
    }

    submitBtn.addEventListener('click', registrarAsistencia);
</script>
</body>
</html>
