<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro de Asistencia</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<h1>Registro de Asistencia</h1>

<form id="asistenciaForm">
    <label>Nombre:</label>
    <input type="text" id="nombre" required>

    <label>Correo:</label>
    <input type="email" id="correo" required>

    <label>Empresa:</label>
    <input type="text" id="empresa" required>

    <label>TelÃ©fono:</label>
    <input type="tel" id="telefono" required>

    <label>Firma:</label>
    <canvas id="signature-pad" width="300" height="150" style="border:1px solid #000;"></canvas>
    <div class="buttons">
        <button type="button" id="clear">Borrar firma</button>
        <button type="button" id="enviar">Registrar asistencia</button>
    </div>
</form>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // ðŸ”¹ ConfiguraciÃ³n de Supabase (ya con tus datos reales)
    const SUPABASE_URL = "https://kdacskidrbbqbstizekl.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtkYWNza2lkcmJicWJzdGl6ZWtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNTQ1NDIsImV4cCI6MjA3NjczMDU0Mn0.SqnbCRbwI4EWYp14VAF8HR5SmeaF4FNI5bUVOCuD0wM";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const canvas = document.getElementById("signature-pad");
    const ctx = canvas.getContext("2d");
    let drawing = false;

    canvas.addEventListener("mousedown", () => drawing = true);
    canvas.addEventListener("mouseup", () => drawing = false);
    canvas.addEventListener("mousemove", dibujar);

    canvas.addEventListener("touchstart", (e) => { drawing = true; e.preventDefault(); });
    canvas.addEventListener("touchend", () => drawing = false);
    canvas.addEventListener("touchmove", (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        dibujar({ clientX: touch.clientX, clientY: touch.clientY });
    });

    function dibujar(e) {
        if (!drawing) return;
        const rect = canvas.getBoundingClientRect();
        ctx.lineWidth = 2;
        ctx.lineCap = "round";
        ctx.strokeStyle = "black";
        ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    document.getElementById("clear").addEventListener("click", () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.beginPath();
    });

    document.getElementById("enviar").addEventListener("click", async () => {
        const nombre = document.getElementById("nombre").value.trim();
        const correo = document.getElementById("correo").value.trim();
        const empresa = document.getElementById("empresa").value.trim();
        const telefono = document.getElementById("telefono").value.trim();
        const sessionId = new URLSearchParams(window.location.search).get("sessionId");

        if (!nombre || !correo || !empresa || !telefono) {
            alert("Por favor, completa todos los campos.");
            return;
        }

        const dataURL = canvas.toDataURL("image/png");
        const blob = await (await fetch(dataURL)).blob();

        // ðŸ”¹ Subir firma
        const nombreArchivo = `firmas/${Date.now()}_${nombre}.png`;
        const { error: uploadError } = await supabase.storage
            .from("firmas")
            .upload(nombreArchivo, blob, { contentType: "image/png" });

        if (uploadError) {
            console.error("Error al subir firma:", uploadError);
            alert("Error al guardar la firma.");
            return;
        }

        const { data: publicUrlData } = supabase.storage.from("firmas").getPublicUrl(nombreArchivo);
        const firma_url = publicUrlData.publicUrl;

        // ðŸ”¹ Insertar registro en la tabla
        const { error } = await supabase
            .from("asistencias")
            .insert([{ nombre, correo, empresa, telefono, firma_url, session_id: sessionId }]);

        if (error) {
            console.error("Error al guardar:", error);
            alert("Error al registrar asistencia.");
        } else {
            alert("âœ… Asistencia registrada correctamente.");
            document.getElementById("asistenciaForm").reset();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    });
</script>
</body>
</html>
